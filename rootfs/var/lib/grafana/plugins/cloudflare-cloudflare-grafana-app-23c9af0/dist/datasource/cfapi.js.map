{"version":3,"sources":["../../src/datasource/cfapi.js"],"names":["getUTCTimestamp","ts","Date","getTime","getTimezoneOffset","getHash","queryObj","query","_","cloneDeep","since","until","JSON","stringify","getMaxRefreshInterval","interval","parse","moment","duration","metricList","dimensionList","angular","CloudflareProxy","backendSrv","baseUrl","tags","cache","cacheUpdateInterval","requestCachingIntervals","config","Promise","resolve","self","get","then","resp","jsonData","cached_query","hash","notCached","api","timestamp","result","query_range","cache_since","cache_until","cached_query_range","max_refresh_interval","Math","abs","scope","tag","split","tagRegex","match","key","from","cached","path","_get","name","data","success","forEach","e","id","fetchConfig","organizations","params","status","per_page","zones","push","text","value","clusters","map","organization","options","metrics","join","range","utc","toISOString","to","formatFilters","filters","dimensions","out","i","op","operator","cond","condition","length","endpoint","bytime","formatQuery","url","console","log","datasourceRequest","method","module","service"],"mappings":"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","file":"cfapi.js","sourcesContent":["import {metricList, dimensionList} from './metric_def';\n\nimport angular from 'angular';\nimport _ from 'lodash';\nimport moment from 'moment';\n\n// Get UTC timestamp\nfunction getUTCTimestamp() {\n  let ts = new Date();\n  return ts.getTime() + ts.getTimezoneOffset() * 60 * 1000;\n}\n\n// Get hash of the query\nfunction getHash(queryObj) {\n  let query = _.cloneDeep(queryObj);\n  query.since = null;\n  query.until = null;\n  return JSON.stringify(query);\n}\n\n// Prevent too frequent queries\nfunction getMaxRefreshInterval(query) {\n  let interval = Date.parse(query.until) - Date.parse(query.since);\n  if (interval > moment.duration(1, 'months')) {\n    return 60 * 60 * 1000; // 1 hour\n  } else if (interval > moment.duration(1, 'day')) {\n    return 15 * 60 * 1000; // 15 min\n  } else {\n    return 5 * 60 * 1000; // 5 min\n  }\n}\n\nclass CloudflareProxy {\n  constructor(backendSrv) {\n    this.backendSrv = backendSrv;\n    this.baseUrl = 'api/plugin-proxy/cloudflare-app';\n    this.tags = {};\n    this.cache = {};\n    this.cacheUpdateInterval = 5 * 60 * 1000; // 5 min by default\n    this.requestCachingIntervals = {\n      '1d': 0\n    };\n  }\n\n  fetchConfig() {\n    if (this.config) {\n      return Promise.resolve(this.config);\n    }\n    var self = this;\n    /* Resolve organizations for this datasource */\n    return this.backendSrv.get('api/plugins/cloudflare-app/settings').then(resp => {\n      this.config = resp.jsonData;\n      return this.config;\n    }, () => {\n      this.config = {};\n      return this.config;\n    });\n  }\n\n  fetchData(query) {\n    let cached_query = _.cloneDeep(query);\n    let hash = getHash(cached_query);\n\n    if (this.notCached(query)) {\n      return this.api(query).then(result => {\n        let timestamp = getUTCTimestamp();\n        this.cache[hash] = {\n          timestamp: timestamp,\n          query: cached_query,\n          result: result\n        };\n        return result;\n      });\n    } else {\n      return Promise.resolve(this.cache[hash].result);\n    }\n  }\n\n  notCached(query) {\n    let hash = getHash(query);\n    let timestamp = getUTCTimestamp();\n    let since = Date.parse(query.since);\n    let until = Date.parse(query.until);\n    let query_range = until - since;\n    let cache_since = this.cache[hash] ? Date.parse(this.cache[hash].query.since) : null;\n    let cache_until = this.cache[hash] ? Date.parse(this.cache[hash].query.until) : null;\n    let cached_query_range = cache_until - cache_since;\n    let max_refresh_interval = getMaxRefreshInterval(query);\n\n    return (\n      !this.cache[hash] ||\n      timestamp - until > max_refresh_interval ||\n      (this.cache[hash] && (\n        timestamp - cache_until > max_refresh_interval ||\n        since < cache_since ||\n        Math.abs(query_range - cached_query_range) > 60 * 1000 // is time range changed?\n        ))\n      );\n  }\n\n  fetchTag(query) {\n    /* Break tag and scope */\n    let scope = query.tag.split('/', 2);\n    let tag = scope[0];\n    scope = scope[1];\n    /* Resolve tag if symbolic */\n    let tagRegex = /[a-z0-9]{32}/g;\n    if (tag.match(tagRegex)) {\n      return Promise.resolve(query.tag);\n    }\n    /* Check tag cache */\n    let key = '#' + query.from + ':' + query.tag;\n    let cached = this.tags[key];\n    if (cached) {\n      query.tag = cached;\n      return Promise.resolve(cached);\n    }\n    let path = 'zones';\n    if (query.from == 'vdns') {\n      path = 'user/virtual_dns';\n      if (scope) {\n        path = 'organizations/' + scope + '/virtual_dns'\n      }\n    }\n    /* Resolve the tag name to ID */\n    return this._get('/api/v4/'+path, {name: tag}).then(resp => {\n      let data = resp.data;\n      if (!data || !data.success) {\n        return '';\n      }\n      data.result.forEach(e => {\n        if (e.name == tag) {\n          let id = e.id;\n          if (scope) {\n            id = id + '/' + scope;\n          }\n          this.tags[key] = id;\n          /* Replace query tag and return */\n          query.tag = id;\n          return id;\n        }\n      });\n    });\n  }\n\n  fetchOrganizations() {\n    return this.fetchConfig().then(() => {\n      if (!this.config.organizations) {\n        return [];\n      }\n      return this.config.organizations;\n    });\n  }\n\n  fetchZones() {\n    /* Default parameters */\n    let params = {\n      status: 'active',\n      per_page: 50\n    }\n    /* Get list of zones */\n    return this._get('/api/v4/zones', params).then(resp => {\n      let data = resp['data'];\n      if (!data || !data.success) {\n        return [];\n      }\n      /* Gather list of active zones */\n      let zones = [];\n      data.result.forEach(e => {\n        zones.push({text: e.name, value: e.id});\n      });\n      return zones;\n    });\n  }\n\n  fetchClusters() {\n    return this.fetchConfig().then(() => {\n      if (!this.config.clusters) {\n        return [];\n      }\n      return this.config.clusters.map(e => {\n        /* Glue organisation id to cluster id\n         * so that metric fetching knows whether to call\n         * organizations or user endpoint */\n        let id = e.id;\n        if (e.organization) {\n          id = id + '/' + e.organization;\n        }\n        return {text: e.name, value: id};\n      });\n    });\n  }\n\n  formatQuery(options) {\n    let query = {\n      \"metrics\": options.metrics.join(','),\n      \"since\": options.range.from.utc().toISOString().split('.')[0]+'Z',\n      \"until\": options.range.to.utc().toISOString().split('.')[0]+'Z',\n      \"filters\": this.formatFilters(options.filters)\n    };\n    if (options.dimensions) {\n      query.dimensions = options.dimensions;\n    }\n\n    return query;\n  }\n\n  formatFilters(filters) {\n    let out = [];\n    filters.forEach((e, i) => {\n      let op = e.operator;\n      /* Convert equality operator */\n      if (op == '=') {\n        op = '==';\n      }\n      out.push(e.key + op + e.value);\n      /* Add condition if chaining */\n      let cond = e.condition || 'AND';\n      if (i < filters.length - 1) {\n        out.push(cond);\n      }\n    });\n    return out.join(' ');\n  }\n\n  api(query) {\n    let endpoint = '/dns_analytics/report';\n    if (query.bytime) {\n      endpoint = endpoint + '/bytime';\n    }\n    let params = this.formatQuery(query);\n    let scope = query.tag.split('/', 2);\n    let tag = scope[0];\n    scope = scope[1];\n    /* Add organization endpoint prefix */\n    if (scope) {\n      scope = '/api/v4/organizations/' + scope;\n    }\n    /* Select either zone or cluster */\n    if (query.from == 'vdns') {\n      if (!scope) {\n        scope = '/api/v4/user';\n      }\n      return this._get(scope + '/virtual_dns/' + tag + endpoint, params);\n    }\n    if (!scope) {\n      scope = '/api/v4/zones';\n    }\n    return this._get(scope + '/' + tag + endpoint, params);\n  }\n\n  _get(url, data) {\n    console.log()\n    return this.backendSrv.datasourceRequest({\n      method: 'GET',\n      url: this.baseUrl + url,\n      params: data\n    });\n  }\n}\n\nangular\n.module('grafana.services')\n.service('proxySrv', CloudflareProxy);"]}